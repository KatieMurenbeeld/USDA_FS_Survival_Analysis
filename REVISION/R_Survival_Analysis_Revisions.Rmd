---
title: "R for US Forest Service Projects Survival Analysis"
author: "Katie Murenbeeld"
date: "5/31/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
```

# Introduction

The following code was used to perform the various survival analyses for this research. Please see the Python folder in this repository for a Jupyter Notebook with instructions for downloading the USFS activities data. See also the R folder in this repositroty for the R script (R_USFS_Survival_Data_Processing.R) used for further data processing of the USFS activities datasets. This R script also has the code for combining the activities datasets (FS_ACT) with the UNM-PALS data. The UMN-PALS data (Fleischman et al., 2020) is in the Data folder of this repository and can be downloaded from here: https://conservancy.umn.edu/handle/11299/211669. References can be found in the References folder of this repository. 

## Load libraries

```{r libraries, echo=TRUE, eval=TRUE}
library(tidyverse)
library(forcats)
library(survminer)
library(survival)
library(lubridate)
library(reshape2)
library(ggplot2)
library(ggpubr)
library(fastDummies)
library(chron)

# Set your working directory to wherever you placed your processed FS-PALS dataaset.

setwd("/Users/kathrynmurenbeeld/Desktop/Desktop - Kathrynâ€™s MacBook Pro/Survival_Analysis/Oct_presentation/")

# Set up to see more rows of output if desired

options(max.print = 10000)
```

## Load the data

Data from post-processing. See **Download_Convert_Subset_Forest_Service_Data-for-Survival-Analysis-v02.ipynb** in the Python folder of this repository for instructions on downloading and subsetting the USFS activities data. See **R_USFS_Survival_Data_Processing.R** in the R folder of this repository for instrcutions on further data processing and combining with the PALS data.

```{r data, echo=TRUE, eval=TRUE}
## Load the data for survival analysis

df_fin <- read.csv("df_c20201020_v02.csv")
df_fin <- df_fin %>%
  select(-X) 

## Replace "Inf" in the project delay column with NA
df_fin$proj.delay[is.infinite(df_fin$proj.delay)] <- NA 
## Bring in binomial and categorical data as a factor
df_fin$REGION <- as.factor(df_fin$REGION)
df_fin$LITIGATED <- as.factor(df_fin$LITIGATED)
df_fin$APPEALED <- as.factor(df_fin$APPEALED)
df_fin$size <- as.factor(df_fin$size)

## Relevel the size data in order from small to extra-large
## In this dataframe Regions are in numerical order (1->6)
df_fin <- df_fin %>%
  mutate(size = fct_relevel(size, 
            "small", "medium", "large", "x-large"))

df_fin <- dummy_cols(df_fin, select_columns = 'REGION')
df_fin <- dummy_cols(df_fin, select_columns = 'NEPA_TYPE')

df_fin$DECISION_DATE <- as.Date(chron(format(df_fin$DECISION_DATE, format="%m/%d/%y")))

df_fin$plan.date.min <- as.Date(df_fin$plan.date.min)

df_fin$overlap <-difftime(df_fin$DECISION_DATE, df_fin$plan.date.min, units="days")

# Create dummy columns for overlap. 
# 0 for no overlap (minimum planned project later than ROD)
# 1 for overlap (minimum planned projected planned before ROD reached)
df_fin$overlap[is.infinite(df_fin$overlap)] <- NA  
df_fin$OVERLAP_DAYS <- ifelse(df_fin$overlap >= 0, 1, 0)
df_fin$OVERLAP_DAYS[is.na(df_fin$OVERLAP_DAYS)] <- 0

## Create different data frames with Regions releveled. 
## This is required to test the impact of using different 
## Regions as a baseline or reference in the Cox proportional 
## analysis.
df_fin2 <- df_fin %>%
  mutate(REGION = fct_relevel(REGION, 
            "2", "1", "3", "4", "5", "6"))

df_fin3 <- df_fin %>%
  mutate(REGION = fct_relevel(REGION, 
            "3", "1", "2", "4", "5", "6"))

df_fin4 <- df_fin %>%
  mutate(REGION = fct_relevel(REGION, 
            "4", "1", "2", "3", "5", "6"))

df_fin5 <- df_fin %>%
  mutate(REGION = fct_relevel(REGION, 
            "5", "1", "2", "3", "4", "6"))

df_fin6 <- df_fin %>%
  mutate(REGION = fct_relevel(REGION, 
            "6", "1", "2", "3", "4", "5"))
```

# Check for data correlations

```{r corr, echo=TRUE, eval=TRUE}

#df_fin_cor <- transform (df_fin, NEPA_TYPE = factor(NEPA_TYPE, 
#                                                    levels = c("CE", "EA", "EIS"),
#                                                    labels = c(1, 2, 3)))
#df_fin_cor <- transform(df_fin_cor, size = factor(size,
#                                                  levels = c("small", "medium", "large", "x-large"),
#                                                  label = c(1, 2, 3, 4)))

#covariates <- data.frame(as.numeric(df_fin_cor$proj.delay), as.numeric(df_fin_cor$proj.dur.plan), as.numeric(df_fin_cor$NEPA_TYPE), as.numeric(df_fin_cor$LITIGATED), as.numeric(df_fin_cor$APPEALED), as.numeric(df_fin_cor$size), as.numeric(df_fin_cor$overlap), 
#as.numeric(df_fin_cor$REGION_1), as.numeric(df_fin_cor$REGION_2), as.numeric(df_fin_cor$REGION_3), as.numeric(df_fin_cor$REGION_4), as.numeric(df_fin_cor$REGION_5), as.numeric(df_fin_cor$REGION_6), as.numeric(df_fin_cor$th), as.numeric(df_fin_cor$rf), as.numeric(df_fin_cor$hf),
#as.numeric(df_fin_cor$tsi), as.numeric(df_fin_cor$act.count), as.numeric(df_fin_cor$YP))

covariates <- data.frame(as.numeric(df_fin$proj.delay), as.numeric(df_fin$proj.dur.plan), as.numeric(df_fin$NEPA_TYPE_CE),  as.numeric(df_fin$NEPA_TYPE_EA),  as.numeric(df_fin$NEPA_TYPE_EIS), as.numeric(df_fin$LITIGATED), as.numeric(df_fin$size), as.numeric(df_fin$num.units.plan), as.numeric(df_fin$overlap), as.numeric(df_fin$OVERLAP_DAYS), as.numeric(df_fin$REGION_1), as.numeric(df_fin$REGION_2), as.numeric(df_fin$REGION_3), as.numeric(df_fin$REGION_4), as.numeric(df_fin$REGION_5), as.numeric(df_fin$REGION_6), as.numeric(df_fin$th), as.numeric(df_fin$rf), as.numeric(df_fin$hf), as.numeric(df_fin$tsi), as.numeric(df_fin$act.count))

col <- cor(covariates)

##write.csv(col, "~/Desktop/Survival_Analysis/WRITING/TABLES/correlation_20210406.csv")
```

# Why care?

When it comes to USFS project planning and inititaion there is some anecdotal evidence for NEPA causing delays, but there are very few quantitative studies of delays.

```{r wcc, echo=FALSE, fig.align="center", fig.cap="Recent letter to Congress from Western Congressional Causcus", out.width = '75%'}
knitr::include_graphics("Wester_Caucus_02.png")

```

# Survival Analysis 

"Time to Event"

- Time until an individual dies (or is cured!).
- Time until a kitten or puppy is adopted.
- Any time an outcome is a **duration**
- Requires a start date, end date, duration (time between), if the event occurred, and the time of observation.
- Survival package in R (Therneau, 2021)

```{r kitpup, echo=FALSE, fig.align="center", out.width = '75%'}
knitr::include_graphics("kit_pup.jpg")

```

## Compare some of the numerical data

```{r overlap_explor, echo=TRUE, eval=TRUE}

#overlap < - ggplot(df_fin, aes(df_fin$overlap, df_fin$proj.delay))
#overlap + geom_point()
plot(df_fin$overlap, log(df_fin$proj.delay))
plot(log(df_fin$act.count), log(df_fin$proj.delay))
plot(log(df_fin$num.units.plan), log(df_fin$proj.delay))
plot(log(df_fin$proj.dur.plan), log(df_fin$proj.delay))
plot(df_fin$ELAPSED_DAYS, log(df_fin$proj.delay))
#plot(df_fin$ELAPSED_DAYS, df_fin$overlap)
#plot(df_fin$proj.dur.plan, df_fin$overlap)
#plot(df_fin$act.count, df_fin$overlap)
#plot(df_fin$act.count, df_fin$proj.dur.plan)

plot(df_fin$hf, log(df_fin$proj.delay))

hist(as.numeric(df_fin$overlap), breaks = 30)
hist(as.numeric(df_fin$proj.delay), breaks = 30)
#hist(df_fin$th)
#hist(df_fin$hf)
#hist(df_fin$tsi)
#hist(df_fin$rf)
```

```{r overlap_counts, echo=TRUE, eval=TRUE}

length(which(df_fin$overlap == 0))
length(which(df_fin$overlap == 0 & df_fin$NEPA_TYPE == 'CE'))
length(which(df_fin$overlap == 0 & df_fin$NEPA_TYPE == 'EA'))
length(which(df_fin$overlap == 0 & df_fin$NEPA_TYPE == 'EIS'))


length(which(df_fin$overlap > 0))
length(which(df_fin$overlap > 0 & df_fin$NEPA_TYPE == 'CE'))
length(which(df_fin$overlap > 0 & df_fin$NEPA_TYPE == 'EA'))
length(which(df_fin$overlap > 0 & df_fin$NEPA_TYPE == 'EIS'))

length(which(df_fin$overlap < 0))
length(which(df_fin$overlap < 0 & df_fin$NEPA_TYPE == 'CE'))
length(which(df_fin$overlap < 0 & df_fin$NEPA_TYPE == 'EA'))
length(which(df_fin$overlap < 0 & df_fin$NEPA_TYPE == 'EIS'))

pos_overce <- df_fin[ which(df_fin$overlap > 0 & df_fin$NEPA_TYPE == 'CE'), ]
neg_overce <- df_fin[ which(df_fin$overlap < 0 & df_fin$NEPA_TYPE == 'CE'), ]
mean(pos_overce$overlap)
mean(neg_overce$overlap)
mean(df_fin$overlap)

length(which(df_fin$overlap > 0 & df_fin$LITIGATED == 0))
length(which(df_fin$overlap > 0 & df_fin$LITIGATED == 1))
length(which(df_fin$overlap < 0 & df_fin$LITIGATED == 0))
length(which(df_fin$overlap < 0 & df_fin$LITIGATED == 1))
length(which(df_fin$overlap == 0 & df_fin$LITIGATED == 0))
length(which(df_fin$overlap == 0 & df_fin$LITIGATED == 1))

length(which(df_fin$overlap > 0 & df_fin$LITIGATED == 1 & df_fin$NEPA_TYPE == 'EIS'))
length(which(df_fin$overlap > 0 & df_fin$LITIGATED == 1 & df_fin$NEPA_TYPE == 'EA'))
length(which(df_fin$overlap > 0 & df_fin$LITIGATED == 1 & df_fin$NEPA_TYPE == 'CE'))
```

## Different approaches

- **Kaplan-Meier** --> non-parametric, predictive (Kaplan & Meier, 1958)
- **Cox Proportional Hazards** --> semi-parametric, use to estimate effect of covariate, not predictive (Cox, 1972)

# Survival Analysis - Kaplan Meier 

## All data - Kaplan Meier (KM) Estimate

Using all the data pooled.

```{r km_mod_all, echo=TRUE, eval=TRUE}

# Use the survfit function from the survival package to 
# calculate the KM estimate 

fit_delay_all <- survfit(Surv(proj.delay, INITIATED) ~ 1, data = df_fin)
fit_delay_all
#summary(fit_delay_all)
```

## Survival Analysis - All - Kaplan Meier Curves

All data

```{r km_curv_all, echo=TRUE, eval=TRUE, warning=FALSE}

## ggsurvvplot will create survival curves from the KM model created above.

km_fit_all <- ggsurvplot(fit_delay_all,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           palette = c("forestgreen"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75, 
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_fit_all)

#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_fit_all.pdf", print(km_fit_all),  device="pdf", dpi=300)
```

## Survival Analysis - All - Kaplan Meier - Cumulative Hazard

All data

```{r km_haz_all, echo=TRUE, eval=TRUE, warning=FALSE}

# ggsurvplot will create the cumulative hazard plots based on the KM model created above.

km_haz_all <- ggsurvplot(fit_delay_all,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           palette = c("forestgreen"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                          axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_all)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_all.pdf", print(km_haz_all),  device="pdf", dpi=300 )
```

## Overlap? - Kaplan Meier (KM) Estimate


```{r km_mod_over, echo=TRUE, eval=TRUE}

# Use the survfit function from the survival package to 
# calculate the KM estimate 

fit_delay_over <- survfit(Surv(proj.delay, INITIATED) ~ OVERLAP_DAYS, data = df_fin)
fit_delay_over
#summary(fit_delay_all)
```

## Survival Analysis - Overlap? - Kaplan Meier Curves


```{r km_curv_over, echo=TRUE, eval=TRUE, warning=FALSE}

## ggsurvvplot will create survival curves from the KM model created above.

km_fit_over <- ggsurvplot(fit_delay_over,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           palette = c("#999999", "forestgreen"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75, 
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_fit_over)

#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_fit_over.pdf", print(km_fit_all),  device="pdf", dpi=300)
```

## Survival Analysis - Overlap? - KM Cumulative Hazard

```{r km_haz_over, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_over <- ggsurvplot(fit_delay_over,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           palette = c("#999999", "forestgreen"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_over)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_over.pdf", print(km_haz_app),  device="pdf", dpi=300 )
```

## Survival Analysis - Appealed? - KM Estimate

Data grouped by appealed and non-appealed projects.

```{r km_mod_app, echo=TRUE, eval=TRUE, warning=FALSE}
# Use the survfit function from the survival package to 
# calculate the KM estimate for data grouped by appealed or non-appealed.
# This code chunk and the next two act as a template for the K-M estimation.

fit_app <- survfit(Surv(proj.delay, INITIATED) ~ APPEALED, data = df_fin)
fit_app_table <- summary(fit_app)
fit_app
```

## Survival Analysis - Appealed? - KM Curve

```{r km_curv_app, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_app <- ggsurvplot(fit_app,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           palette = c("#999999", "skyblue"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_app)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_app.pdf", print(km_curv_app),  device="pdf", dpi=300 )
```

## Survival Analysis - Appealed? - KM Cumulative Hazard

```{r km_haz_app, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_app <- ggsurvplot(fit_app,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           palette = c("#999999", "skyblue"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_app)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_app.pdf", print(km_haz_app),  device="pdf", dpi=300 )
```

## Survival Analysis - Litigated? - KM Estimate

Data grouped by litigated and non-litigated projects.

```{r km_mod_lit, echo=TRUE, eval=TRUE, warning=FALSE}

fit_lit <- survfit(Surv(proj.delay, INITIATED) ~ LITIGATED, data = df_fin)
fit_lit_table <- summary(fit_lit)
fit_lit
```

## Survival Analysis - Litigated? - KM Curve

```{r km_curv_lit, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_lit <- ggsurvplot(fit_lit,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           palette = c("#999999", "forestgreen"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_lit)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_lit.pdf", print(km_curv_lit),  device="pdf", dpi=300 )
```

## Survival Analysis - Litigated? - KM Cumulative Hazard

```{r km_haz_lit, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_lit <- ggsurvplot(fit_lit,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           palette = c("#999999", "forestgreen"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_lit)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_lit.pdf", print(km_haz_lit),  device="pdf", dpi=300 )
```

## Survival Analysis - NEPA Type - KM Estimate

Data grouped by NEPA type for projects. *EIS* = Environmental Impact Statement, *EA* = Environmental Assessment, *CE* = Categorical Exclusion

```{r km_mod_nepa, echo=TRUE, eval=TRUE, warning=FALSE}

fit_delay <- survfit(Surv(proj.delay, INITIATED) ~ NEPA_TYPE, data = df_fin)
fit_nepa_table <- summary(fit_delay)
fit_delay 
```

## Survival Analysis - NEPA Type - KM Curve

```{r km_curv_nepa, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_nepa <- ggsurvplot(fit_delay,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           palette = c("#999999", "#E69F00", "#56B4E9"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_nepa)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_nepa.pdf", print(km_curv_nepa),  device="pdf", dpi=300 )
```

## Survival Analysis - NEAP Type - KM Cumulative Hazard

```{r km_haz_nepa, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_nepa <- ggsurvplot(fit_delay,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           palette = c("#999999", "#E69F00", "#56B4E9"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_nepa)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_nepa.pdf", print(km_haz_nepa),  device="pdf", dpi=300 )
```

## Survival Analysis - Regions - KM Estimate

Data grouped by project location. United Stated Forest Service (USFS) Regions 1-6

```{r km_mod_reg, echo=TRUE, eval=TRUE, warning=FALSE}

fit_reg <- survfit(Surv(proj.delay, INITIATED) ~ REGION, data = df_fin)
fit_reg_table <- summary(fit_reg)
fit_reg
```

## Survival Analysis - Regions - KM Curve

```{r km_curv_reg, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_reg <- ggsurvplot(fit_reg,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_reg)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_reg.pdf", print(km_curv_reg),  device="pdf", dpi=300 )
```

## Survival Analysis - Regions - KM Cumulative Hazard

```{r km_haz_reg, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_reg <- ggsurvplot(fit_reg,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_reg)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_reg.pdf", print(km_haz_reg),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_01 - KM Estimate

Data grouped by project location. United Stated Forest Service (USFS) Regions 1-6

```{r km_mod_reg01, echo=TRUE, eval=TRUE, warning=FALSE}

fit_reg01 <- survfit(Surv(proj.delay, INITIATED) ~ REGION_1, data = df_fin)
fit_reg01_table <- summary(fit_reg01)
fit_reg01
```

## Survival Analysis - Region_01 - KM Curve

```{r km_curv_reg01, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_reg01 <- ggsurvplot(fit_reg01,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999", "#E69F00"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_reg01)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_reg01.pdf", print(km_curv_reg01),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_01 - KM Cumulative Hazard

```{r km_haz_reg01, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_reg01 <- ggsurvplot(fit_reg01,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999","#E69F00"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_reg01)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_reg01.pdf", print(km_haz_reg01),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_02 - KM Estimate

Data grouped by project location. United Stated Forest Service (USFS) Regions 1-6

```{r km_mod_reg02, echo=TRUE, eval=TRUE, warning=FALSE}

fit_reg02 <- survfit(Surv(proj.delay, INITIATED) ~ REGION_2, data = df_fin)
fit_reg02_table <- summary(fit_reg02)
fit_reg02
```

## Survival Analysis - Region_02 - KM Curve

```{r km_curv_reg02, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_reg02 <- ggsurvplot(fit_reg02,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999", "#56B4E9"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_reg02)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_reg02.pdf", print(km_curv_reg02),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_02 - KM Cumulative Hazard

```{r km_haz_reg02, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_reg02 <- ggsurvplot(fit_reg02,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999","#56B4E9"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_reg02)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_reg02.pdf", print(km_haz_reg02),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_03 - KM Estimate

Data grouped by project location. United Stated Forest Service (USFS) Regions 1-6

```{r km_mod_reg03, echo=TRUE, eval=TRUE, warning=FALSE}

fit_reg03 <- survfit(Surv(proj.delay, INITIATED) ~ REGION_3, data = df_fin)
fit_reg03_table <- summary(fit_reg03)
fit_reg03
```

## Survival Analysis - Region_03 - KM Curve

```{r km_curv_reg03, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_reg03 <- ggsurvplot(fit_reg03,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999", "red"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_reg03)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_reg03.pdf", print(km_curv_reg03),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_03 - KM Cumulative Hazard

```{r km_haz_reg03, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_reg03 <- ggsurvplot(fit_reg03,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999","red"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_reg03)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_reg03.pdf", print(km_haz_reg03),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_04 - KM Estimate

Data grouped by project location. United Stated Forest Service (USFS) Regions 1-6

```{r km_mod_reg04, echo=TRUE, eval=TRUE, warning=FALSE}

fit_reg04 <- survfit(Surv(proj.delay, INITIATED) ~ REGION_4, data = df_fin)
fit_reg04_table <- summary(fit_reg04)
fit_reg04
```

## Survival Analysis - Region_04 - KM Curve

```{r km_curv_reg04, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_reg04 <- ggsurvplot(fit_reg04,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999", "forestgreen"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_reg04)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_reg04.pdf", print(km_curv_reg04),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_04 - KM Cumulative Hazard

```{r km_haz_reg04, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_reg04 <- ggsurvplot(fit_reg04,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999","forestgreen"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_reg04)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_reg04.pdf", print(km_haz_reg04,  device="pdf", dpi=300 )
```

## Survival Analysis - Region_05 - KM Estimate

Data grouped by project location. United Stated Forest Service (USFS) Regions 1-6

```{r km_mod_reg05, echo=TRUE, eval=TRUE, warning=FALSE}

fit_reg05<- survfit(Surv(proj.delay, INITIATED) ~ REGION_5, data = df_fin)
fit_reg05_table <- summary(fit_reg05)
fit_reg05
```

## Survival Analysis - Region_05 - KM Curve

```{r km_curv_reg05, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_reg05 <- ggsurvplot(fit_reg05,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999", "blue"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_reg05)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_reg05.pdf", print(km_curv_reg05),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_05 - KM Cumulative Hazard

```{r km_haz_reg05, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_reg05 <- ggsurvplot(fit_reg05,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999","blue"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_reg05)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_reg05.pdf", print(km_haz_reg05),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_06 - KM Estimate

Data grouped by project location. United Stated Forest Service (USFS) Regions 1-6

```{r km_mod_reg06, echo=TRUE, eval=TRUE, warning=FALSE}

fit_reg06 <- survfit(Surv(proj.delay, INITIATED) ~ REGION_6, data = df_fin)
fit_reg06_table <- summary(fit_reg06)
fit_reg06
```

## Survival Analysis - Region_06 - KM Curve

```{r km_curv_reg06, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_reg06 <- ggsurvplot(fit_reg06,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999", "lightpink"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_reg06)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_reg06.pdf", print(km_curv_reg06),  device="pdf", dpi=300 )
```

## Survival Analysis - Region_06 - KM Cumulative Hazard

```{r km_haz_reg06, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_reg06 <- ggsurvplot(fit_reg06,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           #palette = c("#999999", "#E69F00", "#56B4E9", "red", "forestgreen", "blue"),
           palette = c("#999999","lightpink"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),  
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_reg06)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_reg06.pdf", print(km_haz_reg06),  device="pdf", dpi=300 )
```


## Survival Analysis - Size - KM Estimate

Data grouped by a project's cumulative size. Size categories = small, medium, large, and extra-large.

Sizes are categorized based on quartile ranges
  + x-large > 2670 acres
  + large 768-2670 acres
  + medium 174-768 acres
  + small < 174 acres

```{r km_mod_size, echo=TRUE, eval=TRUE, warning=FALSE}

fit_size <- survfit(Surv(proj.delay, INITIATED) ~ size, data = df_fin)
fit_size_table <- summary(fit_size)
fit_size
```

## Survival Analysis - Size - KM Curve

```{r km_curv_size, echo=TRUE, eval=TRUE, warning=FALSE}

km_curv_size <- ggsurvplot(fit_size,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           surv.median.line = "hv",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Probability that Project is Not Started",
           xlab = "Project Delay (days)",
           palette = c("#999999", "#E69F00", "#56B4E9", "red"),
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                           axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()), 
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_curv_size)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_curv_size.pdf", print(km_curv_size),  device="pdf", dpi=300 )
```

## Survival Analysis - Size - KM Cumulative Hazard

```{r cum_size, echo=TRUE, eval=TRUE, warning=FALSE}

km_haz_size <- ggsurvplot(fit_size,
           conf.int = TRUE,
           risk.table = FALSE,
           risk.table.col = "strata",
           break.time.by = 365,
           risk.table.y.text=FALSE,
           tables.height = 0.3,
           censor = FALSE,
           ylab = "Cumulative Hazard",
           xlab = "Project Delay (days)",
           palette = c("#999999", "#E69F00", "#56B4E9", "red"),
           fun = "cumhaz",
           surv.plot.height = 1,
           ggtheme = theme(aspect.ratio = 0.75,
                      axis.line = element_line(colour = "black"),
                           panel.grid.major = element_line(colour = "grey"),
                           panel.border = element_blank(),
                           panel.background = element_blank()),     
           tables.theme =  theme(aspect.ratio = 0.06)
           )
print(km_haz_size)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/km_haz_size.pdf", print(km_haz_size),  device="pdf", dpi=300 )
```

## Comparing survival curves using a log-rank approach

- Null hypothesis: no difference in survival between the groups
- Non-parametric test

Log-Rank - Appealed?

```{r log-rank_app, echo=TRUE, eval=TRUE, warning=FALSE}

# The survdiff function in the survival package does this for you.

surv_diff_delay_app <- survdiff(Surv(proj.delay, INITIATED) ~ APPEALED, data = df_fin)
print(surv_diff_delay_app)
```

Log-Rank - Litigated?
```{r long-rank_lit, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_lit <- survdiff(Surv(proj.delay, INITIATED) ~ LITIGATED, data = df_fin)
print(surv_diff_delay_lit)
```

Log-Rank - NEPA

```{r log-rank_nepa, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_nepa <- survdiff(Surv(proj.delay, INITIATED) ~ NEPA_TYPE, data = df_fin)
print(surv_diff_delay_nepa)
```

Log-Rank - Region

```{r log-rank_reg, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_reg <- survdiff(Surv(proj.delay, INITIATED) ~ REGION, data = df_fin)
print(surv_diff_delay_reg)
```

Log-Rank - Region_01

```{r log-rank_reg01, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_reg01 <- survdiff(Surv(proj.delay, INITIATED) ~ REGION_1, data = df_fin)
print(surv_diff_delay_reg01)
```

Log-Rank - Region_02

```{r log-rank_reg02, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_reg02 <- survdiff(Surv(proj.delay, INITIATED) ~ REGION_2, data = df_fin)
print(surv_diff_delay_reg02)
```

Log-Rank - Region_03

```{r log-rank_reg03, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_reg03 <- survdiff(Surv(proj.delay, INITIATED) ~ REGION_3, data = df_fin)
print(surv_diff_delay_reg03)
```

Log-Rank - Region_04

```{r log-rank_reg04, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_reg04 <- survdiff(Surv(proj.delay, INITIATED) ~ REGION_4, data = df_fin)
print(surv_diff_delay_reg04)
```

Log-Rank - Region_05

```{r log-rank_reg05, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_reg05 <- survdiff(Surv(proj.delay, INITIATED) ~ REGION_5, data = df_fin)
print(surv_diff_delay_reg05)
```

Log-Rank - Region_06

```{r log-rank_reg06, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_reg06 <- survdiff(Surv(proj.delay, INITIATED) ~ REGION_6, data = df_fin)
print(surv_diff_delay_reg06)
```

Log-Rank - size

```{r log-rank_size, echo=TRUE, eval=TRUE, warning=FALSE}
surv_diff_delay_size <- survdiff(Surv(proj.delay, INITIATED) ~ size, data = df_fin)
print(surv_diff_delay_size)
```

# Cox Proportional Hazards (Cox ph) Model

## Test Cox proportional hazards assumptions

There are 5 assumptions for using a Cox PH model

1. Non-informative censoring
2. Survival times, t, are independent
3. Hazards are proportional (clog-log for categorical)
4. ln(HR) is a linear function of *numerical* covariates
5. Covariate values don't change over time (eg. changing a treatment or dosage)
6. The baseline hazard (ie. hazard if all covariates were 0) is unspecified

## Cox PH - Test proportionality assumption
c-log-log test Litigated?

```{r clog_lit, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
## If saving the plots using this method, then make sure to uncomment dev.off().

cox_lit_clog <- survfit(Surv(proj.delay, INITIATED) ~ LITIGATED, data = df_fin)

##pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_lit_clog.pdf")

plot(cox_lit_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

## Cox PH - Test proportionality assumption
c-log-log test NEPA?

```{r clog_nepa, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
## If saving the plots using this method, then make sure to uncomment dev.off().

cox_nepa_clog <- survfit(Surv(proj.delay, INITIATED) ~ NEPA_TYPE_CE, data = df_fin)

##pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_lit_clog.pdf")

plot(cox_nepa_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

c-log-log test Appealed?

```{r clog_app, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
cox_app_clog <- survfit(Surv(proj.delay, INITIATED) ~ APPEALED, data = df_fin)

#pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_app_clog.pdf")

plot(cox_app_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

c-log-log test Region?

```{r clog_reg, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
cox_reg_clog <- survfit(Surv(proj.delay, INITIATED) ~ REGION, data = df_fin)

#pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_reg_clog.pdf")

plot(cox_reg_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

c-log-log test Region 1?

```{r clog_reg1, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
cox_reg1_clog <- survfit(Surv(proj.delay, INITIATED) ~ REGION_1, data = df_fin)

#pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_reg_clog.pdf")

plot(cox_reg1_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

c-log-log test Region2?

```{r clog_reg2, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
cox_reg2_clog <- survfit(Surv(proj.delay, INITIATED) ~ REGION_2, data = df_fin)

#pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_reg_clog.pdf")

plot(cox_reg2_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

c-log-log test Region3?

```{r clog_reg3, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
cox_reg3_clog <- survfit(Surv(proj.delay, INITIATED) ~ REGION_3, data = df_fin)

#pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_reg_clog.pdf")

plot(cox_reg3_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

c-log-log test Size?

```{r clog_size, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
cox_size_clog <- survfit(Surv(proj.delay, INITIATED) ~ size, data = df_fin)

#pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_size_clog.pdf")

plot(cox_size_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

Test non-linearity for numerical (continuous) data

```{r nonlin, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
ggcoxfunctional(Surv(proj.delay, INITIATED) ~ act.count + log(act.count) + sqrt(act.count), data = df_fin)

ggcoxfunctional(Surv(proj.delay, INITIATED) ~ proj.dur.plan + log(proj.dur.plan) + sqrt(proj.dur.plan), data = df_fin)

#ggcoxfunctional(Surv(proj.delay, INITIATED) ~ overlap + log(as.numeric(overlap)) + sqrt(as.numeric(overlap)), data = df_fin)

#ggcoxfunctional(Surv(proj.delay, INITIATED) ~ ELAPSED_DAYS + log(ELAPSED_DAYS) + sqrt(ELAPSED_DAYS), data = df_fin)

ggcoxdiagnostics(res.cox, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw())

ggcoxdiagnostics(res.cox, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw())

ggcoxdiagnostics(res.cox2, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw())

ggcoxdiagnostics(res.cox2, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw())
```


c-log-log test Size?

```{r clog_size, echo=TRUE, eval=TRUE,  warning=FALSE, out.height="500px"}
cox_size_clog <- survfit(Surv(proj.delay, INITIATED) ~ size, data = df_fin)

#pdf( file = "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_size_clog.pdf")

plot(cox_size_clog, data = df_fin, fun = "cloglog")

#dev.off()
```

# Determining the Cox Proportional Hazards Model

## Test from http://www.sthda.com/english/wiki/cox-proportional-hazards-model univariate coxph

```{r univ_cox, echo=TRUE, eval=TRUE, warning=FALSE}
covariates <- c("NEPA_TYPE_CE", "NEPA_TYPE_EA", "NEPA_TYPE_EIS", "LITIGATED", "ELAPSED_DAYS", "num.units.plan", "act.count", "proj.dur.plan", "overlap", "OVERLAP_DAYS",
                "REGION_1", "REGION_2", "REGION_3", "REGION_4", "REGION_5", "REGION_6", "th", "rf",  "hf", "tsi")
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste('Surv(proj.delay, INITIATED)~', x)))
                        
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = df_fin)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                          x <- summary(x)
                          p.value.wald<-signif(x$wald["pvalue"], digits=2)
                          p.value.lrt<-signif(x$logtest["pvalue"], digits=2)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          HR <-signif(x$coef[2], digits=2);#exp(beta)
                          HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                          HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                          HR <- paste0(HR, " (", 
                                       HR.confint.lower, "-", HR.confint.upper, ")")
                          res<-c(beta, HR, wald.test, p.value.wald, p.value.lrt)
                          names(res)<-c("beta", "HR (95% CI for HR)", "wald.test", 
                                        "p.value.wald", "p.value.lrt")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(univ_results, check.names = FALSE))
as.data.frame(res)


```

```{r res.cox, echo=TRUE, eval=TRUE, warning=FALSE}
res.cox <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE_CE + LITIGATED + ELAPSED_DAYS + act.count + proj.dur.plan + OVERLAP_DAYS + overlap + REGION_3 + REGION_4 + REGION_5 + th + rf + hf + tsi, 
                 data=df_fin)

res.cox2 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE_CE + ELAPSED_DAYS + OVERLAP_DAYS + th + rf, 
                 data=df_fin)

#res.coxstrat <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE_CE + LITIGATED + ELAPSED_DAYS + strata(act.count) + strata(proj.dur.plan) + OVERLAP_DAYS + strata(overlap) + REGION_3 + REGION_4 + REGION_5 + th + rf + hf + tsi, data=df_fin)

print(res.cox)
summary(res.cox)

print(res.cox2)
summary(res.cox2)

res.forest <- ggforest(res.cox, data=df_fin)
print(res.forest)
```

```{r res.cox, echo=TRUE, eval=TRUE, warning=FALSE}
res.cox <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE_CE + LITIGATED + ELAPSED_DAYS + act.count + proj.dur.plan + OVERLAP_DAYS + overlap + REGION_3 + REGION_4 + REGION_5 + th + rf + hf + tsi, 
                 data=df_fin)
res.cox2 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE_CE + ELAPSED_DAYS + OVERLAP_DAYS + th + rf, data=df_fin)
#res.cox2 <- coxph(Surv(proj.delay, INITIATED) ~ rf, data=df_fin)

test.ph1 <- cox.zph(res.cox)
test.ph2 <- cox.zph(res.cox2)

#ggcoxzph(test.ph1)
ggcoxzph(test.ph2)

```

Here we used a likelihood ratios test (LRT) to determine the final form of the Cox proportional hazards model. If p-values are <0.05 the covariate should be included in the model.

```{r cox.cat, echo=TRUE, eval=TRUE, warning=FALSE}
# Use the coxph function to create a Cox proportional hazards model.
cox.test <- coxph(Surv(proj.delay, INITIATED) ~ 1, data = df_fin)
print(cox.test)
```

## Should we add NEPA type?

```{r cox.cat2, echo=TRUE, eval=TRUE, warning=FALSE}
 # Use the coxph function to create a Cox proportional hazards model by NEPA type. 
cox.cat2 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE, data = df_fin)
cox.cat2
x <- summary(cox.cat2)

x$logtest["pvalue"]
```

```{r cox.comp2, echo=TRUE, eval=TRUE, warning=FALSE}
# Here we use the anova function to complete the LRT test. 
anova(cox.cat2, cox.test, test="LRT")

```
**Yes**

## Should we include Litigated?

```{r cox.cat3, echo=TRUE, eval=TRUE, warning=FALSE}

cox.cat3 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED, data = df_fin)
#print(cox.cat3)

anova(cox.cat3, cox.cat2, test="LRT")
```
**Yes** 

## Should we include Appealed?

```{r cox.cat4, echo=TRUE, eval=TRUE, warning=FALSE}
cox.cat4 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + APPEALED, data=df_fin)
#summary(cox.cat3)

anova(cox.cat4, cox.cat3, test="LRT")
```
**No**

## Should we include Region?
```{r cox.cat5, echo=TRUE, eval=TRUE, warning=FALSE}
cox.cat5 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION, data=df_fin)

# Can test if using the dataset with different a different Region as the reference makes a differece.
cox.cat5.2 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION, data=df_fin2)

#summary(cox.cat5)

anova(cox.cat5, cox.cat3, test="LRT")
```
**Yes**

## Should we include size?

```{r cox.cat6, echo=TRUE, eval=TRUE, warning=FALSE}

cox.cat6 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION + size, data=df_fin)
#summary(cox.cat6)

anova(cox.cat6, cox.cat5, test="LRT")
```

The final Cox proportional hazards model should include all covariates exceot for appealed.

Need to create Cox models using each of the dataframes made with a different region set as the reference. 

```{r cox.cat6r, echo=TRUE, eval=TRUE, warning=FALSE}

cox.cat6r2 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION + size, data=df_fin2)
cox.cat6r3 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION + size, data=df_fin3)
cox.cat6r4 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION + size, data=df_fin4)
cox.cat6r5 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION + size, data=df_fin5)
cox.cat6r6 <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION + size, data=df_fin6)

```

## Test with all variables (dummies for Region)

```{r cox.cat_all_dummy, echo=TRUE, eval=TRUE, warning=FALSE}

cox.cat_all_dummy <- coxph(Surv(proj.delay, INITIATED) ~  NEPA_TYPE_EA + NEPA_TYPE_EIS + LITIGATED + REGION_6 + REGION_2 + REGION_3 + REGION_4 + REGION_5 + REGION_1 + size + OVERLAP_DAYS + proj.dur.plan + act.count + th + hf + tsi + rf, data=df_fin)
summary(cox.cat_all_dummy)

anova(cox.test, cox.cat_all_dummy, test="LRT")
```

## Test with all variables (non-dummy varibles)

```{r cox.cat_all, echo=TRUE, eval=TRUE, warning=FALSE}

cox.cat_all <- coxph(Surv(proj.delay, INITIATED) ~ NEPA_TYPE + LITIGATED + REGION + size + overlap + proj.dur.plan + act.count + th + hf + rf + tsi, data=df_fin)
summary(cox.cat_all)

anova(cox.test, cox.cat_all, test="LRT")
```

## Test for the treatment type

```{r cox.cat_treat, echo=TRUE, eval=TRUE, warning=FALSE}

cox.cat_treat <- coxph(Surv(proj.delay, INITIATED) ~ th + hf + tsi + rf, data=df_fin)
cox.cat_treat
summary(cox.cat_treat)

#anova(cox.test, cox.cat_treat, test="LRT")
```
## Create forest plots of Cox proportional hazards models. 

## Cox PH Model - Hazard Ratios - Region 1 as Ref

```{r cox.hr1, echo=TRUE, eval=TRUE, warning=FALSE}

cox_forest_01 <- ggforest(cox.cat6, data=df_fin) 
cox.cat6
print(cox_forest_01)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_forest_01.pdf", print(cox_forest_01),  device="pdf", dpi=300 )

```

```{r cox.hrall, echo=TRUE, eval=TRUE, warning=FALSE}

cox_forest_all <- ggforest(cox.cat_all, data=df_fin)
cox.cat_all
print(cox_forest_all)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_forest_01.pdf", print(cox_forest_01),  device="pdf", dpi=300 )

```

## Cox PH Model - Hazard Ratios - Region 2 as Ref

```{r cox.hr2, echo=TRUE, eval=TRUE, warning=FALSE}

cox_forest_02 <- ggforest(cox.cat6r2, data=df_fin2)

print(cox_forest_02)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_forest_02.pdf", print(cox_forest_02),  device="pdf", dpi=300 )

```

## Cox PH Model - Hazard Ratios - Region 3 as Ref

```{r cox.hr3, echo=TRUE, eval=TRUE, warning=FALSE}

cox_forest_03 <- ggforest(cox.cat6r3, data=df_fin3)

print(cox_forest_03)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_forest_03.pdf", print(cox_forest_03),  device="pdf", dpi=300 )

```

## Cox PH Model - Hazard Ratios - Region 4 as Ref

```{r cox.hr4, echo=TRUE, eval=TRUE, warning=FALSE}

cox_forest_04 <- ggforest(cox.cat6r4, data=df_fin4)

print(cox_forest_04)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_forest_04.pdf", print(cox_forest_04),  device="pdf", dpi=300 )

```

## Cox PH Model - Hazard Ratios - Region 5 as Ref

```{r cox.hr5, echo=TRUE, eval=TRUE, warning=FALSE}

cox_forest_05 <- ggforest(cox.cat6r5, data=df_fin5)

print(cox_forest_05)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_forest_05.pdf", print(cox_forest_05),  device="pdf", dpi=300 )

```

## Cox PH Model - Hazard Ratios - Region 6 as Ref

```{r cox.hr6, echo=TRUE, eval=TRUE, warning=FALSE}

cox_forest_06 <- ggforest(cox.cat6r6, data=df_fin6)

print(cox_forest_06)
#ggsave( "/Users/kathrynmurenbeeld/Desktop/Survival_Analysis/WRITING/FIGS/cox_forest_06.pdf", print(cox_forest_06),  device="pdf", dpi=300 )

```





